---
title: Curso Derivados Facultad de Ciencias UNAM
author: https://github.com/CharlySC/Derivados
date: 'Última fecha de modificación: `r Sys.Date()`'
output:
  html_document:
    df_print: paged
    toc: yes
    toc_float: true
    number_sections: true
    theme: readable
    code_folding: show
subtitle: Carlos Adrián Sandoval Cuenca
header_includes:
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{amsthm}
toc-title: Contenido
---

```{r global_options, include=FALSE,warning=FALSE}
knitr::opts_chunk$set(comment = NA,warning = FALSE,echo=FALSE)
```
\pagenumbering{gobble}
```{r, include=FALSE}
###### Paqueterias ######
library(tidyr)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(fExoticOptions)
```

# Movimiento Browniano y Procesos Estocásticos

## Movimiento Browniano

**Definición 1 (Movimiento Browniano)** Sea $\mathbb{T} = [0,T]$, con $T>0$. Un movimiento Browniano es un procesos estocástico $\{W(t)\}_{t\in\mathbb{T}}$ que satisface:

1. $W(0)=0$ $\mathbb{P}$-c.s.
2. Tiene trayectorias continuas. 
3. Tiene incrementos independientes, es decir, $W(t)-W(s)$ es independiente de $\mathcal{F}_s$ para toda $s<t$.
4. Tiene incrementos estacionarios con $W(t)-W(s)\sim N(0,t-s)$ para toda $s<t$.

Para simular un movimiento browniano, tomamos una partición uniforme $0=t_0<\ldots<t_N=T$ del intervalo $\mathbb{T}$ donde $t_{i+1}-t_i=T/N$, para toda $i\in\{0,\ldots,N-1\}$ y observamos que
\begin{equation}
W(t_n) = \sum_{i=0}^{n-1} W(t_{i+1})-W(t_i)
\end{equation}
donde $W(t_{i+1})-W(t_i)\sim N(0,t_{i+1}-t_i)\sim N(0,T/N)$.

### Movimiento Browniano con Drift

La primer modificación del movimiento Browniano consiste en incluir una tendencia (drift) $\mu$ controla la dirección hacia donde se mueve el Browniano y una volatilidad $\sigma$ que controla el tamaño de las variaciones del Browniano

\begin{equation}
S(t) = S(0) + \mu t + \sigma W(t)
\end{equation}

El problema al usar este modelo es que $\mathbb{P}(S(t)\leq0)>0$-c.s. por lo que si se emplea para modelar el precio de algún activo, se podría incurrir en precios negativos.

### Movimiento Browniano Geométrico

La forma más fácil de corregir el problema anterior es aplicarle una función que sea positiva, lo cual nos lleva al movimiento Browniano Geométrico

\begin{equation}
S(t) = S(0)\exp \left\lbrace \mu t + \sigma W(t) \right\rbrace
\end{equation}

A continuación se muestra una comparativa entre los diferentes movimientos Brownianos con $N=1000$ puntos de la partición

```{r, echo=TRUE}
##### Comparacion entre movimientos brownianos #####

# Funcion para browniano estandar
brown <- function(n,t){
  z <- rnorm(n)
  z <- sqrt(t/n)*z
  w <- c(0,cumsum(z))
  return(w)
}

# Funcion para browniano con drift
brown_drift <- function(n,t,s0,mu,sigma){
  z <- rnorm(n)
  z <- sqrt(t/n)*z
  w <- c(0,cumsum(z))
  t <- seq(0,t,by=t/n)
  s <- s0+mu*t+sigma*w
  return(s)
}

# Funcion para browniano geometrico
brown_geom <- function(n,t,s0,mu,sigma){
  z <- rnorm(n)
  z <- sqrt(t/n)*z
  w <- c(0,cumsum(z))
  t <- seq(0,t,by=t/n)
  s <- s0*exp(mu*t+sigma*w)
  return(s)
}

# Movimientos Brownianos con tendencia positiva
n <- 1000
t <- seq(0,1,1/n)
s0 <- 1
mu <- -.9
sigma <- .8
seed <- 987654
  
set.seed(seed)
s1 <- brown(n,1)

set.seed(seed)
s2 <- brown_drift(n,1,s0,mu,sigma)

set.seed(seed)
s3 <- brown_geom(n,1,s0,mu,sigma)

Simulaciones <- data.frame(tiempo=t,
                           Estandar=s1,
                           Drift=s2,
                           Geometrico=s3)

Simulaciones <- gather(Simulaciones,tipo,valor,-tiempo)
ggplot(Simulaciones,aes(x=tiempo,y=valor,col=tipo)) +
  geom_line() +
  labs(title="Comparación Movimientos Brownianos",subtitle="Tendencia a la baja")

# Movimientos Brownianos con tendencia positiva
mu <- .9 
seed <- 987654

set.seed(seed)
s1 <- brown(n,1)

set.seed(seed)
s2 <- brown_drift(n,1,s0,mu,sigma)

set.seed(seed)
s3 <- brown_geom(n,1,s0,mu,sigma)

Simulaciones <- data.frame(tiempo=t,
                           Estandar=s1,
                           Drift=s2,
                           Geometrico=s3)

Simulaciones <- gather(Simulaciones,tipo,valor,-tiempo)
ggplot(Simulaciones,aes(x=tiempo,y=valor,col=tipo)) +
  geom_line() +
  labs(title="Comparación Movimientos Brownianos",subtitle="Tendencia a la alza")

```

\newpage

## Ecuaciones Diferenciales Estocásticas

En el modelo de Black-Scholes el precio del subyacente sigue la EDE
\begin{equation}
dS(t)=\mu S(t)dt + \sigma S(t)dW(t).
\end{equation}

Aplicando lema de Itô a la función $\log (x)$ y despejando $S(t)$ obtenemos la solución
\begin{equation}
S(t)=S(0)\exp \left\lbrace \left(\mu-\frac{1}{2}\sigma^2\right)t + \sigma W(t) \right\rbrace.
\end{equation}

Para encontrar el precio de una opción se debe convertir en martingala al subyacente $\{S(t)\}_{t\in\mathbb{T}}$ mediante un cambio de medida $\widetilde{\mathbb{P}}$, el cual consiste en utilizar el Teorema de Girsanov para desaparecer el drift $\mu$ en la dinámica del subyacente.

Al hacer esto, la nueva dinámica del subyacente bajo la nueva medida $\widetilde{\mathbb{P}}$ es
\begin{equation}
dS(t)=\sigma S(t)d\widetilde{W}(t),
\end{equation}

cuya solución está dada por
\begin{equation}
S(t)=S(0)\exp \left\lbrace -\frac{1}{2}\sigma^2t + \sigma \widetilde{W}(t) \right\rbrace,
\end{equation}

donde $\widetilde{W}$ es un movimiento Browniano bajo la nueva medida $\widetilde{\mathbb{P}}$. Bajo está nueva dinámica, el proceso $\{S(t)\}_{t\in\mathbb{T}}$ es martingala bajo $\widetilde{\mathbb{P}}$.

```{r,echo=TRUE}
##### Multiples simulaciones #####

# Browniano con tendencia
brown_geom_nomartingala <- function(n,t,s0,mu,sigma){
  z <- rnorm(n)
  z <- sqrt(t/n)*z
  w <- c(0,cumsum(z))
  t <- seq(0,t,by=t/n)
  s <- s0*exp((mu-.5*sigma^2)*t+sigma*w)
  return(s)
}

num_simulaciones <- 50
num_puntos <- 100
s0 <- 100
mu <- .9
sigma <- .2
t <- seq(0,1,1/num_puntos)

Simulaciones <- matrix(0,nrow = num_puntos+1,ncol = num_simulaciones)
for(i in 1:ncol(Simulaciones)){
  Simulaciones[,i] <- brown_geom_nomartingala(num_puntos,1,s0,mu,sigma)
}
Simulaciones <- cbind.data.frame(tiempo=t,Simulaciones)
Simulaciones <- gather(Simulaciones,simulacion,valor,-tiempo)
ggplot(Simulaciones,aes(x=tiempo,y=valor,col=simulacion)) +
  geom_line() +
  labs(title="Comparación Movimientos Brownianos",subtitle="Con Drift") +
  theme(legend.position = 'none')


# Browniano sin tendencia (martingala)
brown_geom_martingala <- function(n,t,s0,mu,sigma){
  z <- rnorm(n)
  z <- sqrt(t/n)*z
  w <- c(0,cumsum(z))
  t <- seq(0,t,by=t/n)
  s <- s0*exp(-.5*sigma^2*t+sigma*w)
  return(s)
}

Simulaciones <- matrix(0,nrow = num_puntos+1,ncol = num_simulaciones)
for(i in 1:ncol(Simulaciones)){
  Simulaciones[,i] <- brown_geom_martingala(num_puntos,1,s0,mu,sigma)
}
Simulaciones <- cbind.data.frame(tiempo=t,Simulaciones)
Simulaciones <- gather(Simulaciones,simulacion,valor,-tiempo)
ggplot(Simulaciones,aes(x=tiempo,y=valor,col=simulacion)) +
  geom_line() +
  labs(title="Comparación Movimientos Brownianos",subtitle="Sin Drift (Martingala)") +
  theme(legend.position = 'none')

```

El concepto de martingala fue introducido por Paul Lèvy en 1934 y mucha de la teoría de martingalas fue desarrollada por Joseph Doob. El concepto está asociado con el precio justo de una apuesta, razón por la cual tiene aplicaciones en el mundo de las finanzas.

De la definición de martingala, tenemos que si $\{S(t)\}_{t\in\mathbb{T}}$ es martingala, entonces por esperanza iterada
\begin{equation*}
\mathbb{E}(S(t)) = \mathbb{E}(\mathbb{E}(S(t)\mid \mathcal{F}_0)) = \mathbb{E}(S(0)) = S(0).
\end{equation*}

## Método de Euler-Maruyama

Consideremos una EDE de la siguiente forma
\begin{equation}
dX(t)=\mu(X(t))dt + \sigma(X(t))dW(t).
\end{equation}

En la mayoría de los casos, resolver EDE es muy difícil, sin embargo, es posible realizar simulaciones del proceso a partir de su EDE a través del método de *Euler-Maruyama*.

Tomando una partición uniforme $0=t_0<t_1\ldots<t_N=T$ del intervalo $\mathbb{T}$, donde $t_{i+1}-t_i=\Delta t$ y un punto inicial $X(0)$, la discretización de Euler-Maruyama está dada por
\begin{align}
Y(0) &= X(0) \\
Y(t_{n+1}) &= Y(t_n) + \mu(Y(t_n))\Delta t + \sigma(Y(t_n))\Delta W,
\end{align}
para $n\in\{1,\ldots,N-1\}$ y con $\Delta W = W(t_{n+1})-W(t_n)\sim N(0,\Delta t)$.

Bajo ciertas condiciones sobre las funciones $\mu(x)$ y $\sigma(x)$, el método de Euler-Maruyama converge a la solución de la EDE a medida que las particiones se hacen más finas, i.e. cuando $N\rightarrow\infty$.

### Proceso de Ornstein–Uhlenbeck (Vasicek)

El proceso de Ornstein–Uhlenbeck está dado por la EDE
\begin{equation}
dX(t)=\kappa(\theta-X(t))dt + \sigma dW(t)
\end{equation}

Este proceso suele utilizarse para modelar tasas de interés, y en este contexto tamnién es conocido como modelo de Vasicek. El parámetro $\theta>0$ mide el punto de convergencia del proceso, el parámetro $\kappa$ mide la velocidad de convergencia al punto $theta>0$ y $\sigma>0$ es el parámetro de la volatilidad.

Un problema de este proceso es que cuando el proceso se encuentra cerca de $0$, la dinámica se convierte en $\kappa\theta dt + \sigma dW(t)$, por lo que el proceso puede ser negativo.

```{r,echo=TRUE}
##### Proceso de Vasicek #####

Vasicek <- function(n,x0,kappa,theta,sigma){
  x <- rep(0,n+1)
  x[1] <- x0
  for (i in 1:n) {
    x[i+1] <- x[i] + kappa*(theta-x[i])*1/n + sigma*1/sqrt(n)*rnorm(1)
  }
  return(x)
}

num_simulaciones <- 10
num_puntos <- 100
x0 <- .4
kappa <- 5
theta <- .1
sigma <- 1.5
t <- seq(0,1,1/num_puntos)

Simulaciones <- matrix(0,nrow = num_puntos+1,ncol = num_simulaciones)
for(i in 1:ncol(Simulaciones)){
  Simulaciones[,i] <- Vasicek(num_puntos,x0,kappa,theta,sigma)
}
Simulaciones <- cbind.data.frame(tiempo=t,Simulaciones)
Simulaciones <- gather(Simulaciones,simulacion,valor,-tiempo)
ggplot(Simulaciones,aes(x=tiempo,y=valor,col=simulacion)) +
  geom_line() +
  labs(title="Proceso de Ornstein-Uhlenbeck (Vasicek)",subtitle="Método Euler-Maruyama") +
  theme(legend.position = 'none')

```

### Proceso de Cox-Ingersoll-Ross

El proceso de Cox-Ingersoll-Ross (CIR) está dado por la EDE
\begin{equation}
dX(t)=\kappa(\theta-X(t))dt + \sigma \sqrt{X(t)}dW(t)
\end{equation}

Este proceso surge como una alternativa al modelo de Vasicek para corregir el problema de negatividad del proceso. En este caso, cuando el proceso se encuentra cerca de $0$, la dinámica se convierte en $\kappa\theta dt$, por lo que el proceso tiende a alejarse de la zona negativa. En general el proceso siempre es no-negativo, sin embargo, si se cumple la condición de Feller $2\kappa \theta > \sigma$, entonces el proceso es estrictamente positivo c-s.

**Observación:** A pesar de que el método de Euler-Maruyama converge a la solución de la EDE, al ser una discretización, lo que se genera es un \underline{proceso estocástico nuevo}, de modo que puede que las propiedades del proceso original no se cumplan, por ejemplo, el modelo CIR, a pesar de ser siempre positivo, al realizar la discretización, puede generar valores negativos y ocasionar problemas con la raíz cuadrada. Para solucionar esto se pueden tomar las siguientes modificaciones en la discretización.

\begin{align}
Y(t_{n+1}) &= Y(t_n) + \kappa(\theta-\mid Y(t_n)\mid)\Delta t + \sigma\sqrt{\mid Y(t_n)\mid}\Delta W, \\
Y(t_{n+1}) &= Y(t_n) + \kappa(\theta-(Y(t_n))_+)\Delta t + \sigma\sqrt{(Y(t_n))_+}\Delta W,
\end{align}

```{r,echo=TRUE,fig.height=3}
##### Proceso CIR #####

CIR <- function(n,x0,kappa,theta,sigma){
  x <- rep(0,n+1)
  x[1] <- x0
  for (i in 1:n) {
    x[i+1] <- x[i] + kappa*(theta-max(x[i],0))*1/n + sigma*sqrt(max(x[i],0))*1/sqrt(n)*rnorm(1)
  }
  return(x)
}

num_simulaciones <- 10
num_puntos <- 100
x0 <- .4
kappa <- 2
theta <- .1
sigma <- .8
t <- seq(0,1,1/num_puntos)

Simulaciones <- matrix(0,nrow = num_puntos+1,ncol = num_simulaciones)
for(i in 1:ncol(Simulaciones)){
  Simulaciones[,i] <- CIR(num_puntos,x0,kappa,theta,sigma)
}
Simulaciones <- cbind.data.frame(tiempo=t,Simulaciones)
Simulaciones <- gather(Simulaciones,simulacion,valor,-tiempo)
ggplot(Simulaciones,aes(x=tiempo,y=valor,col=simulacion)) +
  geom_line() +
  labs(title="Proceso CIR",subtitle="Método Euler-Maruyama") +
  theme(legend.position = 'none')

```

Puesto que ambos procesos tienen el mismo drift, ambos comparten la propiedad de reversión a la media, la diferencia radica entre la volatilidad. La volatilidad en el proceso de Vasicek $\sigma dW(t)$ está controlada únicame por el parámetro $\sigma$, por lo que la volatilidad es relativamente constante en el tiempo. Por otro lado, en el proceso CIR la volatlidad también depende del nivel del mismo proceso $\sigma \sqrt{X(t)}dW(t)$, por lo que a medida que el proceso $X(t)$ se acerca a 0, la volatilidad disminuye y a medida que se aleja de 0, la volatilidad aumenta.

\newpage

## Ejercicios

**Ejercicio (Puente Browniano)** Definimos el puente Browniano como el proceso $B(t)=W(t)-\frac{t}{T}W(T)$, $t\in\mathbb{T}$. Realice simulaciones del puente Browniano.

**Ejercicio (Browniano en el círculo unitario)** Definimos el movimiento Browniano en el círculo unitario como el proceso $X(t)=(sen(W(t)),cos(W(t)))$,  $t\in\mathbb{T}$. Realice simulaciones del Browniano en el círculo unitario.

**Ejercicio** Realice simulaciones del proceso $\int_0^t W(t)dW(t)$.

**Ejercicio** Sea $S(t)$ con EDE $dS(t)=\sigma S(t)dW(t)$. Realice simulaciones del proceso $\{S^p(t)\}_{t\in\mathbb{T}}$.
(Nota: Se deben usar los mismos valores aleatorios para cada valor de $p$)

**Ejercicio (Movimiento Browniano Correlacionado)** Sean $\{W_1(t)\}_{t\in\mathbb{T}}$ y $\{W_2(t)\}_{t\in\mathbb{T}}$ dos movimientos Brownianos y definamos
\begin{align}
B_1(t) &= W_1(t), \\
B_2(t) &= \rho W_1(t) + \sqrt{1-\rho} W_2(t),
\end{align}
con $\rho\in [-1,1]$. 
Demustre que $dB_1(t)dB_2(t)=\rho dt$ y realice simulaciones de $(B_1(t),B_2(t))$ para diferentes valores de $\rho$.

**Ejercicio** Simule $n$ movimientos Brownianos geométricos con mismo parámetro de volatilidad $\sigma$ y diferentes valores de $\mu$ que vayan de 1 a -1 \\
(Nota: Se deben usar los mismos valores aleatorios al momento de generar cada movimiento Browniano, i.e. misma trayectoria)

**Ejercicio** Simule $n$ movimientos Brownianos geométricos con mismo parámetro de tendencia $\mu$ y diferentes valores de $\sigma$ que vayan de 1 a -1 \\
(Nota: Se deben usar los mismos valores aleatorios al momento de generar cada movimiento Browniano, i.e. misma trayectoria)

**Ejercicio** Realice una comparativa de una trayectoria del proceso de Vasicek y el proceso CIR usando los mismos parámetros $X(0),\kappa,\theta$ y $\sigma$ \\
(Nota: Se deben usar los mismos valores aleatorios al momento de generar cada movimiento Browniano, i.e. misma trayectoria)

**Ejercicio** Simule un movimiento Browniano geométrico usando la fórmula cerrada y usando el método de Euler-Maruyama y compare las diferencias. \\
(Nota: Se deben usar los mismos valores aleatorios al momento de generar cada movimiento Browniano, i.e. misma trayectoria)

**Ejercicio (Método de Milstein)** Es posible mejorar la velocidad de convergencia en el metodo de Euler-Maruyama al incluir más términos en el desarollo de su aproximación. Si se incluyen terminos de segundo grado, obtenemos el método de Milstein
\begin{align}
Y(0) &= X(0) \\
Y(t_{n+1}) &= Y(t_n) + \mu(Y(t_n))\Delta t + \sigma(Y(t_n))\Delta W + \frac{1}{2}\sigma(Y(t_n))\sigma'(Y(t_n))(\Delta W^2-\Delta t),
\end{align}
para $n\in\{1,\ldots,N-1\}$ y con $\Delta W = W(t_{n+1})-W(t_n)\sim N(0,\Delta t)$.
Realice simulaciones del proceso Vasicek y del proceso CIR bajo el método de Milstein y compare contra el método de Euler-Maruyama. \\
(Nota: Se deben usar los mismos valores aleatorios al momento de generar cada movimiento Browniano, i.e. misma trayectoria)

**Ejercicio (Modelo Heston)** Definimos el modelo Heston como el proceso
\begin{align}
dS(t) &= \mu S(t)dt + \sqrt{V(t)}S(t)d\widetilde{W}_1(t), \\
dV(t) &= \kappa(\theta -V(t))dt + \sigma\sqrt{V(t)}d\widetilde{W}_2(t), \\
dW_1(t)dW_2(t) &= \rho dt
\end{align}
donde $\{W_1(t)\}_{t\in\mathbb{T}}$ y $\{W_2(t)\}_{t\in\mathbb{T}}$ son 2 movimientos Brownianos correlacionados con $\rho\in[-1,1]$ y la volatilidad $\sqrt{V(t)}$ sigue un proceso CIR (a través del proceso varianza $V(t)$)
Realice simulaciones del modelo Heston bajo el método de Euler-Maruyama.

\newpage

## Bibliografía

* Douglas, R.F. and Heston, S. (2013) *The Heston model and its extensions in Matlab and C\#*, Wiley, New Jersey.
* Heston, S. (1993) *A closed-form solution for options with stochastic volatility and application to bond and currency options*, The Review of Financial Studies, 6, 327-343.
* Hull, J. (2018) *Options, Futures and other Derivative Securities*, 10th edition, Pearson, New York.
* Karatzas, I. and Shreve, S. (1991) *Brownian Motion and Stochastic Calculus*, Springer-Verlag, New York.
* Kloeden, P. and Platen, E. (1995) *Numerical solution of stochastic differential equations*, Springer-Verlag, New York.
* Shreve, S. (2004) *Stochastic Calculus for Finance II: Continuous-Time Models*, Springer-Verlag, New York.


# El modelo de Black-Scholes

El modelo de Black-Scholes (B-S) fue propuesto por el físico y economista Fischer Black y el economista Myron Scholes y posteriormente fue formalizado a través del cálculo estocástico por Robert Merton. El modelo brinda el precio de una opción financiera el cual está dado por la ecuación

\begin{align}
BS(S,K,\tau,r,q,\sigma,\phi) &= \phi Se^{-q\tau}N(\phi d_1) - \phi Ke^{-r\tau}N(\phi d_2) \\
d_1 &= \frac{1}{\sigma\sqrt{\tau}}\left( \log\left( \frac{S}{K}\right) +\left( r-q+\frac{1}{2}\sigma^2 \right) \tau \right), \\
 d_2 &= d_1 - \sigma\sqrt{\tau}
\end{align}
donde

* $S$: Precio spot del subyacente.
* $K$: Precio strike pactado.
* $\tau$: Años por vencer de la opción.
* $r$: Tasa de descuento doméstica.
* $q$: Tasa de descuento extranjera (Tasa de dividendos).
* $\sigma$: Volatilidad anual.
* $\phi$: Indicadora igual a 1 si es call y a -1 si es put.

Para llegar a esta fórmula, se parte de los siguientes supuestos

* Los participantes del mercado son entes racionales.
* La competencia del mercado es perfecta.
* El subyacente no paga dividendos y su precio sigue un movimiento Browniano geométrico.
* Es posible comprar, vender y pedir prestado (venta en corto) cualquier cantidad (no necesariamente entera) del subyacente en cualquier instante de tiempo, sin costos de transacción.
* La tasa de interés libre de riesgo y la volatilidad son constantes en el tiempo.

Bajo la medida de riesgo neutral $\mathbb{\widetilde{P}}$ e incluyendo dividendos, se sigue que el subyacente sigue la EDE
\begin{equation}
dS(t)=(r-q)S(t)dt+\sigma d\widetilde{W}(t),
\end{equation}
donde $\widetilde{W}(t)$ es un movimiento browniano bajo $\mathbb{\widetilde{P}}$.

El precio de la opción está dado por la fórmula de valuación de riesgo neutral
\begin{equation}
\mathbb{\widetilde{E}}(e^{-r(T-t)}X(T)\mid \mathcal{F}_t)
\end{equation}
donde la esperanza se calcula bajo $\mathbb{\widetilde{P}}$, $N(x)$ es la función de distribución de una $N(0,1)$ y $X(T)$ es el payoff del derivado.

```{r,echo=T}
# Funcion para precio de una opcion bajo Black-Scholes
BS <- function(S,K,tau,r,q,sigma,phi){
  d1 <- (log(S/K)+(r-q+.5*sigma^2)*tau)/(sigma*sqrt(tau))
  d2 <- d1-sigma*sqrt(tau)
  precio <- phi*(S*exp(-q*tau)*pnorm(phi*d1)-K*exp(-r*tau)*pnorm(phi*d2))
  return(precio)
}
```

```{r}
######## Simulacion Trayectoria ########
n <- 1000
t <- seq(0,1,1/n)
s0 <- 100
mu <- -.05
sigma <- .5
k <- 100
set.seed(456789)

Simulacion <- data.frame(Tiempo=t,Subyacente=brown_geom(n,1,s0,mu,sigma))
S <- Simulacion$Subyacente[nrow(Simulacion)]
ggplot(Simulacion,aes(x=Tiempo,y=Subyacente)) +
  geom_line() +
  labs(title="Simulacion trayectoria") +
  geom_hline(aes(yintercept = k,color="Strike")) +
  geom_hline(aes(yintercept = S,color="S(T)")) +
  theme(legend.title = element_blank(),legend.position = "bottom")

```

Definimos el *Payoff* de un derivado como el valor intrinseco del derivado en el momento de ser ejercido y el cual puede ser visto como una función del subyacente $X(T)=h(S(T))$.

El precio de un forward se obtiene al tomar un payoff igual a $X(T)=S(T)-K$, el precio de un call se obtiene al usar el payoff $X(T)=(S(T)-K)_+$ y el precio de un put se obtiene al usar el payoff $X(T)=(K-S(T))_+$.


```{r}
######## Payoffs Opciones Vanilla ########

s <- c(k-1:round(k/2),k,k+1:round(k/2))

# Call largo
X <- pmax(s-k,0)
Grafica <- data.frame(Subyacente=s,Payoff=X)
p1 <- ggplot(Grafica,aes(x=Subyacente,y=Payoff)) +
  geom_line() +
  labs(title="Payoff Call",subtitle = "Largo") +
  geom_vline(aes(xintercept = k,color="Strike")) +
  geom_vline(aes(xintercept = S,color="S(T)")) +
  geom_label(aes(x = k, y = mean(X)*2, label = "ATM")) +
  geom_label(aes(x = max(s)-(max(s)-k)/4, y = mean(X)*2, label = "ITM")) +
  geom_label(aes(x = min(s)+(k-min(s))/4, y = mean(X)*2, label = "OTM")) +
  theme(legend.title = element_blank(),legend.position = "bottom")

# Call corto
X <- -pmax(s-k,0)
Grafica <- data.frame(Subyacente=s,Payoff=X)
p2 <- ggplot(Grafica,aes(x=Subyacente,y=Payoff)) +
  geom_line() +
  labs(title="Payoff Call",subtitle = "Corto") +
  geom_vline(aes(xintercept = k,color="Strike")) +
  geom_vline(aes(xintercept = S,color="S(T)")) +
  geom_label(aes(x = k, y = mean(X)*2, label = "ATM")) +
  geom_label(aes(x = max(s)-(max(s)-k)/4, y = mean(X)*2, label = "ITM")) +
  geom_label(aes(x = min(s)+(k-min(s))/4, y = mean(X)*2, label = "OTM")) +
  theme(legend.title = element_blank(),legend.position = "bottom")

# Put largo
X <- pmax(k-s,0)
Grafica <- data.frame(Subyacente=s,Payoff=X)
p3 <- ggplot(Grafica,aes(x=Subyacente,y=Payoff)) +
  geom_line() +
  labs(title="Payoff Put",subtitle = "Largo") +
  geom_vline(aes(xintercept = k,color="Strike")) +
  geom_vline(aes(xintercept = S,color="S(T)")) +
  geom_label(aes(x = k, y = mean(X)*2, label = "ATM")) +
  geom_label(aes(x = max(s)-(max(s)-k)/4, y = mean(X)*2, label = "OTM")) +
  geom_label(aes(x = min(s)+(k-min(s))/4, y = mean(X)*2, label = "ITM")) +
  theme(legend.title = element_blank(),legend.position = "bottom")

# Put corto
X <- -pmax(k-s,0)
Grafica <- data.frame(Subyacente=s,Payoff=X)
p4 <- ggplot(Grafica,aes(x=Subyacente,y=Payoff)) +
  geom_line() +
  labs(title="Payoff Put",subtitle = "Corto") +
  geom_vline(aes(xintercept = k,color="Strike")) +
  geom_vline(aes(xintercept = S,color="S(T)")) +
  geom_label(aes(x = k, y = mean(X)*2, label = "ATM")) +
  geom_label(aes(x = max(s)-(max(s)-k)/4, y = mean(X)*2, label = "OTM")) +
  geom_label(aes(x = min(s)+(k-min(s))/4, y = mean(X)*2, label = "ITM")) +
  theme(legend.title = element_blank(),legend.position = "bottom")

# Forward largo
X <- pmax(s-k,0)-pmax(k-s,0)
Grafica <- data.frame(Subyacente=s,Payoff=X)
p5 <- ggplot(Grafica,aes(x=Subyacente,y=Payoff)) +
  geom_line() +
  labs(title="Payoff Forward",subtitle = "Largo") +
  geom_vline(aes(xintercept = k,color="Strike")) +
  geom_vline(aes(xintercept = S,color="S(T)")) +
  geom_label(aes(x = k, y = mean(X)*2, label = "ATM")) +
  geom_label(aes(x = max(s)-(max(s)-k)/4, y = mean(X)*2, label = "ITM")) +
  geom_label(aes(x = min(s)+(k-min(s))/4, y = mean(X)*2, label = "OTM")) +
  theme(legend.title = element_blank(),legend.position = "bottom")

# Forward corto
X <- k-s
Grafica <- data.frame(Subyacente=s,Payoff=X)
p6 <- ggplot(Grafica,aes(x=Subyacente,y=Payoff)) +
  geom_line() +
  labs(title="Payoff Forward",subtitle = "Corto") +
  geom_vline(aes(xintercept = k,color="Strike")) +
  geom_vline(aes(xintercept = S,color="S(T)")) +
  geom_label(aes(x = k, y = mean(X)*2, label = "ATM")) +
  geom_label(aes(x = max(s)-(max(s)-k)/4, y = mean(X)*2, label = "OTM")) +
  geom_label(aes(x = min(s)+(k-min(s))/4, y = mean(X)*2, label = "ITM")) +
  theme(legend.title = element_blank(),legend.position = "bottom")

ggarrange(p1,p2,p3,p4,p5,p6,ncol = 2,nrow = 3)
```

## Bibliografía

* Karatzas, I. and Shreve, S. (1991) *Brownian Motion and Stochastic Calculus*, Springer-Verlag, New York.
* Kloeden, P. and Platen, E. (1995) *Numerical solution of stochastic differential equations*, Springer-Verlag, New York.
* Hull, J. (2018) *Options, Futures and other Derivative Securities*, 10th edition, Pearson, New York.
* *Shreve, S. (2004) Stochastic Calculus for Finance II: Continuous-Time Models*, Springer-Verlag, New York.
* Wystup, U. (2017) *FX Options and Structure Products*, Wiley, United Kingdom.


# Estrategias

## Estrategias con Opciones Vanilla

Es posible crear nuevos productos como combinación lineal de opciones vanilla (call y put), los cuales reciben el nombre de *estrategias*

### Call Spread (Bull Spread)

Un call spread se conforma de un call largo $\text{Call}(T,K_1)$ y un call corto $\text{Call}(T,K_2)$ con $K_1<K_2$. Este producto permite una cobertura en caso de que el subyacente aumente, limitando la ganancia hasta nivel $K_2$. Al tener la ganancia limitada, este producto resulta más barato que un call tradicional.

```{r fig.width=6, fig.height=4,fig.align="center"}
# Call Spread
k1 <- 125
X <- pmax(s-k,0) - pmax(s-k1,0)
Grafica <- data.frame(Subyacente=s,Payoff=X)
ggplot(Grafica,aes(x=Subyacente,y=Payoff)) +
  geom_line() +
  labs(title="Payoff Call Spread") +
  geom_vline(aes(xintercept = k,color="Strike 1")) +
  geom_vline(aes(xintercept = k1,color="Strike 2")) +
  theme(legend.title = element_blank(),legend.position = "bottom")

```

### Put Spread (Bear Spread)

Un put spread se conforma de un put largo $\text{Put}(T,K_2)$ y un put corto $\text{Put}(T,K_1)$ con $K_1<K_2$. Este producto permite una cobertura en caso de que el subyacente disminuya, limitando la ganancia hasta nivel $K_2$. Al tener la ganancia limitada, este producto resulta más barato que un put tradicional.

```{r fig.width=6, fig.height=4,fig.align="center"}
# Put Spread
k1 <- 75
X <- pmax(k-s,0) - pmax(k1-s,0)
Grafica <- data.frame(Subyacente=s,Payoff=X)
ggplot(Grafica,aes(x=Subyacente,y=Payoff)) +
  geom_line() +
  labs(title="Payoff Put Spread") +
  geom_vline(aes(xintercept = k,color="Strike 1")) +
  geom_vline(aes(xintercept = k1,color="Strike 2")) +
  theme(legend.title = element_blank(),legend.position = "bottom")

```

### Straddle

Un straddle se conforma de un put largo $\text{Put}(T,K)$ y un call largo $\text{Call}(T,K)$. Este producto genera ganancias en cualquier dirección que tome el subyacente, sin embargo, dicha ganancia segura se ve reflejada en un precio alto. Se usa principalmente cuando se prevé gran volatilidad en el mercado.

```{r fig.width=6, fig.height=4,fig.align="center"}
# Straddle
X <- pmax(s-k,0) + pmax(k-s,0)
Grafica <- data.frame(Subyacente=s,Payoff=X)
ggplot(Grafica,aes(x=Subyacente,y=Payoff)) +
  geom_line() +
  labs(title="Payoff Straddle") +
  geom_vline(aes(xintercept = k,color="Strike")) +
  theme(legend.title = element_blank(),legend.position = "bottom")

```

### Strangle

Un strangle se conforma de un put largo $\text{Put}(T,K_1)$ y un call largo $\text{Call}(T,K_2)$ con $K_1<K_2$. Este producto es similar al straddle, sin embargo, el subyacente debe moverse mucho más para que haya ganancias, razón por la resulta más barato que un straddle.

```{r fig.width=6, fig.height=4,fig.align="center"}
# Strangle
k1 <- 75
k2 <- 125
X <- pmax(s-k2,0) + pmax(k1-s,0)
Grafica <- data.frame(Subyacente=s,Payoff=X)
ggplot(Grafica,aes(x=Subyacente,y=Payoff)) +
  geom_line() +
  labs(title="Payoff Strangle") +
  geom_vline(aes(xintercept = k1,color="Strike 1")) +
  geom_vline(aes(xintercept = k2,color="Strike 2")) +
  theme(legend.title = element_blank(),legend.position = "bottom")

```

### Risk-Reversal

Un Risk-Reversal se conforma de un put corto $\text{Put}(T,K_1)$ y un call largo $\text{Call}(T,K_2)$ con $K_1<K_2$. Este producto brinda protección en caso de una subida del subyacente pero genera pérdidas en caso de una disminución en el subyacente. Se puede pactar de forma que su precio sea 0.

```{r fig.width=6, fig.height=4,fig.align="center"}
# Risk-Reversal
k1 <- 75
k2 <- 125
X <- pmax(s-k2,0) - pmax(k1-s,0)
Grafica <- data.frame(Subyacente=s,Payoff=X)
ggplot(Grafica,aes(x=Subyacente,y=Payoff)) +
  geom_line() +
  labs(title="Payoff Risk-Reversal") +
  geom_vline(aes(xintercept = k1,color="Strike 1")) +
  geom_vline(aes(xintercept = k2,color="Strike 2")) +
  theme(legend.title = element_blank(),legend.position = "bottom")

```

### Butterfly

Un Butterfly se conforma de un strangle largo con strikes $K_!$ y $K_3$ y un straddle corto con strike $K_2$, con $K_1<K_2<K_3$. Este producto limita las ganancias en un pequeño rango y se usa principalmente cuando hay poca volatilidad en los mercados. Por lo general, la posición larga en un butterfly *recibe* una prima por entrar en este contrato.

```{r fig.width=6, fig.height=4,fig.align="center"}
# Butterfly
k1 <- 75
k2 <- 125
X <- pmax(s-k1,0) - 2*pmax(s-k,0) + pmax(s-k2,0)
Grafica <- data.frame(Subyacente=s,Payoff=X)
ggplot(Grafica,aes(x=Subyacente,y=Payoff)) +
  geom_line() +
  labs(title="Payoff Butterfly") +
  geom_vline(aes(xintercept = k1,color="Strike 1")) +
  geom_vline(aes(xintercept = k2,color="Strike 2")) +
  theme(legend.title = element_blank(),legend.position = "bottom")

```

## Otros Derivados Europeos

También es posible usar la fórmula de riesgo neutral para valuar otros tipos de derivados europeos que no son vanilla.

### Cash-or-Nothing (Opción Digital)

Un call cash-or-nothing (call digital) brinda a la posición larga un monto $M$ en caso de que el subyacente termine a vencimiento por arriba del strike $S(T)>K$ y 0 en caso contrario. Un put cash-or-nothing (put digital) brinda a la posición larga un monto $M$ en caso de que el subyacente termine a vencimiento por debajo del strike $S(T)<K$ y 0 en caso contratio.

```{r fig.width=6, fig.height=4,fig.align="center"}
# Call Digital
X <- s
X[X<k] <- 0
X[!(X<k)] <- 1
Grafica <- data.frame(Subyacente=s,Payoff=X)
ggplot(Grafica,aes(x=Subyacente,y=Payoff)) +
  geom_line() +
  labs(title="Call Digital") +
  geom_vline(aes(xintercept = k,color="Strike")) +
  theme(legend.title = element_blank(),legend.position = "bottom")

# Put Digital
X <- s
X[X<k] <- 1
X[!(X<k)] <- 0
Grafica <- data.frame(Subyacente=s,Payoff=X)
ggplot(Grafica,aes(x=Subyacente,y=Payoff)) +
  geom_line() +
  labs(title="Put Digital") +
  geom_vline(aes(xintercept = k,color="Strike")) +
  theme(legend.title = element_blank(),legend.position = "bottom")

```

### Asset-or-Nothing

Un call asset-or-nothing brinda a la posición larga el valor del subyacente a vencimiento $S(T)$ en caso de que el subyacente termine a vencimiento por arriba del strike $S(T)>K$ y 0 en caso contrario. Un put asset-or-nothing brinda a la posición larga el valor del subyacente a vencimiento $S(T)$ en caso de que el subyacente termine a vencimiento por debajo del strike $S(T)<K$ y 0 en caso contratio.

```{r fig.width=6, fig.height=4,fig.align="center"}
# Call asset or nothing
X <- s
X[X<k] <- 0
Grafica <- data.frame(Subyacente=s,Payoff=X)
ggplot(Grafica,aes(x=Subyacente,y=Payoff)) +
  geom_line() +
  labs(title="Call Digital") +
  geom_vline(aes(xintercept = k,color="Strike")) +
  theme(legend.title = element_blank(),legend.position = "bottom")

# Put asset or nothing
X <- s
X[X>k] <- 0
Grafica <- data.frame(Subyacente=s,Payoff=X)
ggplot(Grafica,aes(x=Subyacente,y=Payoff)) +
  geom_line() +
  labs(title="Put Digital") +
  geom_vline(aes(xintercept = k,color="Strike")) +
  theme(legend.title = element_blank(),legend.position = "bottom")


```


## Ejercicios

**Ejercicio (Condor)** Un condor tiene payoff como se muestra en la siguiente gráfica.
```{r fig.width=5, fig.height=2.5,fig.align='center',echo=FALSE}
# Condor
k1 <- 60
k2 <- 75
k3 <- 125
k4 <- 140
X <- pmax(s-k1,0) - pmax(s-k2,0) - pmax(s-k3,0) + pmax(s-k4,0)
Grafica <- data.frame(Subyacente=s,Payoff=X)
ggplot(Grafica,aes(x=Subyacente,y=Payoff)) +
  geom_line() +
  labs(title="Payoff Condor")

```
Exprese el condor en terminos de opciones call y put y en términos de strangles.

**Ejercicio** Exprese el butterfly en términos de calls y puts.

**Ejercicio** Encuentre el strike que hace que la delta de un straddle sea 0.

**Ejercicio** Encuentre el strike que maximice la vega.

**Ejercicio** 

1. Encuentre una fórmula para el payoff de un call cash-or-nothing y un call asset-or-nothing.
2. Utilice la fórmula de valuación de riesgo neutral para encontrar el precio de un call cash-or-nothing y un call asset-or-nothing.
3. Demuestre que el precio de un call vanilla se puede expresar en términos de un call cash-or-nothing y un call asset-or-nothing.

**Ejercicio** Definimos un derivado con el siguiente payoff $X(T)=(S(T)-K)_+$ si $K_1<S(T)<K_2$ con $K<K_1<K_2$.

1. Grafique el payoff.
2. Exprese el derivado en términos de un call cash-or-nothing y un call asset-or-nothing y encuentre su precio.

**Ejercicio (Chooser Option)** Sea $C(t;T,K)$ el valor de una opción call, $P(t;T,K)$ el valor de una opción put y $f(t;T,K)$ el valor de un forward.
Una opción chooser permite a la posición larga escoger en una fecha $t_0\in[0,T]$ entre una opción call y una opción put, ambas con mismo strike $K$ y vencimiento $T$.

1. Demustre que el payoff a tiempo $t_0$ se puede escribir como $$C(t_0)+\max\{0,-f(t_0)\}=C(t_0)+(e^{-t(T-t_0)}K-S(t_0))_+$$
2. Demustre que el valor de la opción chooser a tiempo 0 es igual a una opción call $C(0;T,K)$ más una opción put $P(0;t_0,e^{-r(T-t_0)}K)$.

Hint: Utilice la paridad put-call, la fórmula de valuación de riesgo neutral y esperanza iterada.

## Bibliografía

* Musiela, M. and Rutkowski, M. (2005) *Martingale Methods in Financial Modelling*, Spinger-Verlag, New York. 
* Shreve, S. (2004) *Stochastic Calculus for Finance II: Continuous-Time Models*, Springer-Verlag, New York.
* Wystup, U. (2017) *FX Options and Structure Products*, Wiley, United Kingdom.


# El modelo Binomial

## Supuestos

El modelo Cox-Ross-Rubinstein (también conocido como *modelo binomal*) fue propuesto por Cox, Ross y Rubinstein en 1979 como una discretización del modelo de Black-Scholes basado en árboles multiplicativos, el cual resulta muy útil para valuar opciones americanas y exóticas.

Dado un intervalo de tiempo $\mathbb{T}=[0,T]$, con $T>0$ y una partición uniforme de $\mathbb{T}$, $0=t_0<\ldots,t_N=T$ donde $\Delta t=t_k-t_{k-1}=T/N$ para toda $k=1,\ldots,N$, el modelo parte de modelar el precio subyacente $S$, el cual en cada tiempo $t_k$ puede incrementar por un factor $u$ (*up*) o disminuir por un factor $d$ (*down*), con $u>d$.

Partiendo del precio spot del subyacente $S_0$, a tiempo $t_1$, el valor del subyacente puede pasar a $S_u$ con probabilidad $q$ en caso de aumentar o a $S_d$ con probabilidad $1-q$ en caso de disminuir. El término multiplicativo se refiere a que $S_u=uS_0$ y $S_d=dS_0$. A tiempo $t_2$, el activo puede tomar las siguientes rutas $S_{uu}=u^2S_0$ con proba $q^2$, $S_{ud}=udS_0=S_{du}$ con proba $q(1-q)$ o $S_{dd}=d^2S_0$ con proba $(1-q)^2$, y así sucesivamente para cada $t_k$ como se muestra en la siguiente Figura.

\begin{figure}[h]
\centering
\includegraphics[width=.6\linewidth]{ModeloBinomial.png}
\end{figure}

Una vez modelado la dinámica del subyacente, procedemos a introducir la cuenta de mercado de dinero $B(t,T)$, el cual corresponde con el valor de una unidad de dinero a tiempo $t$ en un tiempo futuro $T$ y el cual está dado por 
\begin{equation}
B(t,T)=e^{r(T-t)},
\end{equation}
donde $r$ es la *tasa libre de riesgo*.

La proba $q$ corresponde a la *medida de riesgo neutral*, la cual evita que existan oportunidades de arbitraje. Se puede demostrar que 
\begin{equation}
q=\frac{B(t_{k-1},t_k)S_0-S_d}{S_u-S_d}=\frac{e^{r\Delta t}S_0-S_d}{S_u-S_d}=\frac{e^{r\Delta t}-d}{u-d}.
\end{equation}

Considere ahora un derivado europeo $X$ con payoff $X_T=h(S_T)$. Por ejemplo, para el caso de un call $X_T=(S_T-K)_+$ y para el caso de un put $X_T=(K-X_T)_+$. 

Bajo el modelo binomial, el precio del derivado $X$ con payoff $h(S_T)$ está dado por
\begin{equation}
V_0 = e^{-rT}\mathbb{E}(h(S_T)) =e^{-rT}\sum_{k=0}^N {N \choose k} q^N(1-q)^{N-k}\ h(u^Nd^{N-k}S_0).
\end{equation}

La fórmula anterior también se puede calcular de manera recursiva. Definamos $S_k^m$  el valor del activo a tiempo $t_k$ en el nodo $m$ para cada $k=0,\ldots,N$ y $m=0,\ldots,k$ y de forma análoga el valor del derivado $V_k^m$. Bajo esta nueva notación tenemos que a tiempo $t_0=0$, $S_0=S_0^0$, a tiempo $t_1$, $S_1^0=dS_0$ y $S_1^1=uS_0$, a tiempo $t_2$, $S_2^0=d^2S_0$, $S_2^1=udS_0$ y $S_2^2=u^2S_0$, y así sucesivamente. En general, a tiempo $t_k$, el activo puede tomar uno de los siguiente $m+1$ valores $S_k^m=u^kd^{k-m}S_0$, para $m=0,\ldots,k$. Por lo tanto, el valor del derivado $V_0^0$ está dado de forma recursiva por
\begin{align}
V_N^m &= h(S_N^m), \quad m=0,\ldots,N \label{payoff} \\ 
V_k^m &= e^{-r\Delta t}\left[ qV_{k+1}^{m+1}+(1-q)V_{k+1}^m\right], \quad k=0,\ldots,N-1, \quad m=0,\ldots,k. \label{precio}
\end{align}


## Implementación

En la práctica usualmente se toma $q=\frac{1}{2}$, lo cual implica que la probabilidad de subir es igual a la probabilidad de bajar y con lo cual se obtiene 
\begin{align}
u &= e^{r\Delta t}(1+\sqrt{e^{\sigma^2\Delta t}-1}), \\
d &= e^{r\Delta t}(1-\sqrt{e^{\sigma^2\Delta t}-1}),
\end{align}
donde $\sigma$ es la volatilidad del subyacente. Para mayor detalle se puede consultar Willmott (1995).

Una vez conocidos los factores $u$ y $d$, el primer paso para valuar una opción call es construir el árbol multiplicativo del subyacente. Para esto creamos la función **arbol_S** la cual utiliza los siguientes parámetros.

* $\tau$: Vencimiento de la opción (en años).
* $N$: Número de particiones del intervalo $[0,\tau]$.
* $S$: Precio spot del subyacente.
* $r$: Tasa libre de riesgo (anual).
* $\sigma$: Volatilidad del subyacente (anual).

```{r, include=TRUE,echo=TRUE}
arbol_S <- function(tau,N,S,r,sigma){
  delta_t <- tau/N
  arbol <- matrix(0,nrow = N+1,ncol = N+1)
  u <- exp(r*delta_t)*(1+sqrt(exp(sigma^2*delta_t)-1))
  d <- exp(r*delta_t)*(1-sqrt(exp(sigma^2*delta_t)-1))
  for (i in 1:nrow(arbol)) {
    for (j in 1:i) {
      arbol[i, j] = S*u^(j-1)*d^((i-1)-(j-1))
    }  
  }
  return(arbol)
}
arbol_S(tau=1,N=4,S=100,r=.05,sigma=.2)
```

La función **arbol_S** genera un árbol con $N+1$ nodos (columnas) y $N+1$ puntos intermedios (renglones) del intervalo de tiempo $[0,t]$.

Una vez generado el árbol del subyacente, procedemos a generar el árbol del derivado con la función **arbol_V**, la cual usa los mismos parámetros que la función **arbol_S** y adicionalmente usa

* $K$: Precio strike.
* $\phi$: Variable indicadora donde $\phi=1$ para call y $\phi=-1$ para put.

```{r, include=TRUE,echo=TRUE}
arbol_V <- function(S,K,tau,N,r,sigma,phi){
  delta_t <- tau/N
  u <- exp(r*delta_t)*(1+sqrt(exp(sigma^2*delta_t)-1))
  d <- exp(r*delta_t)*(1-sqrt(exp(sigma^2*delta_t)-1))
  arbol_aux <- arbol_S(tau,N,S,r,sigma)
  q <- (exp(r*delta_t)-d)/(u-d)
  
  arbol <- matrix(0,nrow = nrow(arbol_aux),ncol = ncol(arbol_aux))
  arbol[nrow(arbol),] <- pmax(phi*arbol_aux[nrow(arbol_aux),]-phi*K,0)
  
  for(i in (nrow(arbol)-1):1){
    for(j in 1:i){
      arbol[i,j] <- exp(-r*delta_t)*(q*arbol[i+1,j+1]+(1-q)*arbol[i+1,j])
    }
  }
  resultado=list(precio=arbol[1,1],
                 arbol_activo=arbol_aux,
                 arbol_opcion=arbol)
  return(resultado)
}
arbol_V(S=100,K=100,tau=1,N=4,r=.05,sigma=.2,phi=1)
```

La función **arbol_V** reutiliza la función **arbol_S** para generar el árbol del subyacente, sin embargo, lo único que necesitamos de aquél árbol es su valor a vencimiento $S_T=S_N^m$, $m=0,\ldots,N$, con el cual calculamos el payoff $X_T$ y de ahí en adelante calculamos el precio del derivado $V_0^0$ hacia atrás con las ecuaciones (\ref{payoff}) y (\ref{precio}).

Con el fin de corroborar nuestras cuentas, comparamos el precio de la opción call con spot $S=100$, strike $K=100$, tasa libre de riesgo $r=5\%$, volatilidad $\sigma=20\%$ y vencimiento $T$ de un año, el cual bajo el modelo binomial con $N=4$ particiones es igual a `r arbol_V(t=1,N=4,S=100,K=100,r=.05,sigma=.2,phi=1)$precio`, mientras que bajo el modelo de Black-Scholes obtenemos `r BS(S=100,K=100,tau=1,r=.05,q=0,sigma=.2,phi=1)`. En la medida que se tomen más particiones, i.e. $N\rightarrow \infty$, el modelo binomial converge al modelo de B-S.

## Ejercicios

**Ejercicio** Considere el modelo binomial a un periodo $\{0,T\}$ con precio spot del activo $S_0$ y cuenta de mercado de dinero $B(0,T)$. Demuestre que si $S_d<B(0,T)S_0<S_u$, entonces no existen oportunidades de arbitraje y $0<q<1$.

**Ejercicio** Elabore una gráfica donde el eje de las $x$ sea el número de particiones $N$ del intervalo $\mathbb{T}$ y en el eje $y$ sea la diferencia entre el precio de una opción put bajo el modelo binomial y bajo el modelo de B-S (Use los mismos parámetros en cada modelo).

**Ejercicio** Una **opción americana** permite a la parte larga ejercer el contrato en cualquier instante $t\in\mathbb{T}$. Para valuar está opción se debe modificar la función recursiva (\ref{precio}) por 
\begin{equation}
V_k^m = \max\{h(S_k^m),e^{-r\Delta t}\left[ qV_{k+1}^{m+1}+(1-q)V_{k+1}^m\right]\}, \quad k=0,\ldots,N-1, \quad m=0,\ldots,k.
\end{equation}
Modifique la función **arbol_V** para valuar opciones americanas y corrobore sus resultados con alguna paquetería existente para valuar opciones americanas.

## Bibliografía

* Shreve, S. (2004) *Stochastic Calulus for Finance I: The Binomial Asste Pricing Model*, Springer-Verlag, New York.
* Willmott, P. (1995) *The Mathematics of Financial Derivatives: A Student Introduction*, Cambridge University Press, Cambridge.

# Monte Carlo y Opciones Exóticas

## Monte Carlo

La fórmula de valuación de riesgo neutral brinda el precio de cualquier derivado europeo con payoff $X(T)=h(S(T))$ y está dada por 
\begin{equation}
\widetilde{\mathbb{E}}(e^{-r(T-t)}X(T)\mid \mathcal{F}_t)
\end{equation}

donde el subyacente sigue la siguiente dinámica estocástica bajo la medida de riesgo neutral $\widetilde{\mathbb{P}}$
\begin{equation}
dS(t)=(r-q)S(t)dt+\sigma S(t)d\widetilde{W}(t),
\end{equation}
y con distribución $S(T)=S(0)e^Z$ con $Z$ una distribución normal
\begin{equation}
Z \sim N\left(\left(r-q-\frac{1}{2}\sigma^2\right)T,\sigma^2T\right)
\end{equation}

La técnica de Monte Carlo se basa en la *ley de los grandes números*, la cual establece que la esperanza de una v.a. $Z$ converge a la media muestral cuando el tamaño de la muestra tiende a infinito, es decir,
\begin{equation}
\mathbb{E}(f(Z))=\lim_{n\rightarrow\infty}\frac{1}{n}\sum_{i=1}^n f(z_i)
\end{equation}

Esta técnica suele usarse para valuar opciones donde el cálculo de la esperanza no tiene una fórmula semi-analítica. 

Para empezar, ejemplificaremos su uso con una opción call europea $C(T,K)$. Para esto se utilizará la fórmula de valuación de riesgo neutral con payoff $X(T)=(S(T)-K)_+$ y $S(T)$ como se definió anteriormente. Por lo tanto, primero se generará una muestra aleatoria $\{s_1,\ldots,s_n\}$ de la v.a. $S=S(T)$
\begin{align*}
C(T,K) &= \mathbb{E}(e^{-rT}(S(T)-K)_+) \\
&\approx\frac{1}{n}\sum_{i=1}^n e^{-rT}(s_i-K)_+
\end{align*}

```{r,echo=T}

r <- .04125
q <- .00125
mu <- r-q
sigma <- .2
tau <- 180/360
S <- 19.85
K <- s*exp((r-q)*t)
phi <- 1

BS(S,K,tau,r,q,sigma,phi)

num_sim <- 1000000
media <- (r-q-.5*sigma^2)*t
desv <- sigma*sqrt(t)
z <- rnorm(num_sim,media,desv)
mean(exp(-r*t)*pmax(s*exp(z)-k,0))

```

## Opciones Exóticas

Las opciones exóticas son aquellas donde el payoff de la opción depende de la trayectoria recorrida por el subyacente. Estos productos por lo general son más baratos que los derivados vanilla y sirven para para participantes de mercado con una expectativa muy específica del mercado. La variedad de opciones exóticas es muy grande, sin embargo, después de la crisis de los 90 su popularidad cayó.

### Opciones Barrera

Unas de las opciones exóticas más famosas son las opciones barrera, en las cuales se tiene una opción call o put y se establece una barrera, en la cual la opción se desactiva (*knock-out*) o se activa (*knock-in*) cuando alcanza toca labarrera. La barrera puede fijarse por debajo (*down*) o por arriba (*up*) del precio spot. Por ejemplo, una opción call que se desactiva cuando supera la barrera recibe el nombre de *call up-and-out*. También es posible incluir dos barreras y hacer combinaciones in y out con ambas.

El payoff de una opción call up-and-out con barrera $B$ está dado por $(S(T)-K)_+$ si $S(t)<B$ para toda $t\in[0,T]$. Definamos $M(T)=\max\{S(t);t\in[0,T]\}$, entonces dicho payoff también puede escribirse como 
\begin{equation}
(S(T)-K)_+\textbf{1}_{\{M(T)<B\}}
\end{equation}
y es posible encontrar una distribución para el máximo de la trayectoria del subyacente y la correlación entre este y el subyacente para obtener una fórmula semi-analítica bajo el modelo de Black-Scholes.

```{r}

barrera <- 1.2*k
num_sim <- 1000
num_puntos <- 200
tau <- 180/360
Simulaciones <- matrix(0,nrow = num_puntos+1,ncol = num_sim)
for(i in 1:ncol(Simulaciones)){
  Simulaciones[,i] <- brown_geom(num_puntos,tau,s,mu,sigma)
}
Simulaciones <- cbind.data.frame(tiempo=(1:nrow(Simulaciones))/360,Simulaciones)
Simulaciones <- gather(Simulaciones,simulacion,valor,-tiempo)
ggplot(Simulaciones,aes(x=tiempo,y=valor,col=simulacion)) +
  geom_line() +
  labs(title="Simulacion Movimiento Browniano") +
  geom_hline(aes(yintercept = barrera,color="Barrera")) +
  theme(legend.position = 'none')

```

El precio de una opción call up-and-out con barrera `r barrera` es

```{r, echo=T}

Indicadora <- Simulaciones %>%
  select(simulacion,valor) %>%
  group_by(simulacion) %>%
  summarize(max=max(valor)) %>%
  mutate(indicadora=ifelse(max>barrera,0,1))

Payoff <- Simulaciones[which(Simulaciones$tiempo==max(Simulaciones$tiempo)),] %>%
  left_join(Indicadora[,c("simulacion","indicadora")],by="simulacion") %>%
  mutate(tiempo=NULL,
         payoff=pmax(valor-k,0)*indicadora)

mean(exp(-r*tau)*Payoff$payoff)
```

Comparando nuestro resultado con la paquetería **fExoticOptions** obtenemos

```{r, echo=T}
StandardBarrierOption(TypeFlag = "cuo",
                      S = s,
                      X = k,
                      H = barrera,
                      K = 0,
                      Time = tau,
                      r = r,
                      b = r-q,
                      sigma = sigma)
```

### Opciones Asiáticas

Las opciones asiáticas promedian la trayectoria recorrida por el subyacente, dicha media puede ser aritmética, geométrica o armónica.

A continuación se muestran los diferentes tipos de payoff, donde $A(T)$ representa la media de la trayectoria recorrida.
\begin{itemize}
\item Average strike call: $(A(T)-K)_+$
\item Average strike put: $(K-A(T))_+$
\item Average price call: $(S(T)-A(T))_+$
\item Average price put: $(A(T)-S(T))_+$
\end{itemize}

Este tipo de opción tiene una fórmula semi-analítica para el tipo geométrico pero no para el artimético ni armónico.

```{r, echo=T}
Payoff <- Simulaciones %>%
  select(simulacion,valor) %>%
  group_by(simulacion) %>%
  summarize(promedio=exp(mean(log(valor)))) %>%
  mutate(payoff=pmax(promedio-k,0))

mean(exp(-r*tau)*Payoff$payoff)
```

Comparando nuestro resultado con la paquetería **fExoticOptions** obtenemos

```{r, echo=T}
GeometricAverageRateOption(TypeFlag = "c",
                      S = s,
                      X = k,
                      Time = tau,
                      r = r,
                      b = r-q,
                      sigma = sigma)
```

### Opciones Lookback

Las opciones lookback se fijan en los valores máximos o mínimos del subyacente durante la vida del contrato.

A continuación se muestran los diferentes tipos de payoff, donde $M(T)$ representa el máximo de la trayectoria y $m(T)$ el mínimo de la trayectoria.

* Floating strike call: $M(T)-S(T)$
* Floating strike put: $S(T)-m(T)$
* Fixed strike call: $(M(T)-K)_+$
* Fixed strike put: $(K-m(T))_+$
* Lookback Straddle / Range: $M(T)-m(T)$

Este tipo de opción cuenta con fórmulas semi-analíticas bajo el modelo de Black-Scholes.

```{r, echo=T}
Payoff <- Simulaciones %>%
  select(simulacion,valor) %>%
  group_by(simulacion) %>%
  summarize(min=min(valor)) %>%
  mutate(payoff=pmax(k-min,0))

mean(exp(-r*tau)*Payoff$payoff)
```

Comparando nuestro resultado con la paquetería **fExoticOptions** obtenemos

```{r, echo=T}
FixedStrikeLookbackOption(TypeFlag = "c",
                          S = s,
                          SMinOrMax = min(Simulaciones$valor),
                          X = k,
                          Time = tau,
                          r = r,
                          b = r-q,
                          sigma = sigma)
```

## Ejercicios

**Ejercicio (Barrier Option)** Agregue la característica de que en una opción barrera, en caso de hacer knock-out, la opción pague un monto fijo $M$. Modifique el código anterior para valuar una opción put down-and-out con esta modificación y compare sus resultados con la paquetería **fExoticOptions**.

**Ejercicio (Double Barrier Option)** Modifique el código anterior para valuar una opción put doble-barrera up-and-out-down-and-out y compare sus resultados con la paquetería **fExoticOptions**.

**Ejercicio (Parisian Option)** Una opción parisina es un tipo de opción barrera exótica donde el subyacente debe permanecer por arriba o por debajo de la barrera cierto número de días (en total) para que ocurre el knock-in o el knock-out. Modifique el código anterior para valuar una opción call parisina up-and-out.

**Ejercicio (Asian Option)** Modifique el código anterior para valuar una opción asiática average price call, con media aritmética.

**Ejercicio (Lookback Option)** Modifique el código anterior para valuar una opción lookback straddle.

## Bibliografía

* Shreve, S. (2004) *Stochastic Calculus for Finance II: Continuous-Time Models*, Springer-Verlag, New York.
* Wystup, U. (2017) *FX Options and Structure Products*, Wiley, United Kingdom.


# Griegas

```{r,echo=TRUE}
######## Griegas ########

r <- .05
q <- .0025
sigma <- .15
K <- 20
S <- seq(17,23,.1)
tau <- c(7,30,180,360)/360

tau_aux <- data.frame(Tau=tau,
                      Vencimiento=c("1 dia","1 mes","6 meses","1 año"))

```

A partir de la fórmula de B-S es posible obtener sensibilidades del derivado con respecto a los parámetros, las cuales se conocen como *griegas*. A continuación se presentan las fórmulas para opciones largas, las respectivas fórmulas para la opción corta, son las negativas de las largas.

## Delta

La delta corresponde a la sensibilidad del precio del derivado con respecto al precio del subyacente.
\begin{equation}
\Delta = \frac{\partial BS}{\partial S} = \phi e^{-q\tau}N(\phi d_1).
\end{equation}
Este valor tiene un significado especial y representa la cantidad de subyacente que se debe comprar (vender) para cubrir una posición corta (larga) (*delta-hedge*).

```{r,echo=TRUE,fig.height=3}
# Delta
Delta <- function(S,K,tau,r,q,sigma,tipo){
  d1 <- (log(S/K)+(r-q-.5*sigma^2)*tau)/(sigma*sqrt(tau))
  N1 <- tipo*exp(-q*tau)*pnorm(tipo*d1)
  return(N1)
}

tipo <- 1
Grafica <- data.frame(S=rep(S,length(tau)),Tau=rep(tau,each=length(S)))
Grafica[,"Delta"] <- mapply(Delta,Grafica$S,K,Grafica$Tau,r,q,sigma,tipo)
Grafica <- left_join(Grafica,tau_aux,by = "Tau")
Grafica$Tau <- NULL
ggplot(Grafica,aes(x=S,y=Delta,color=Vencimiento)) +
  geom_line() +
  labs(title="Delta Call",subtitle = "Largo",x="Subyacente")

tipo <- -1
Grafica <- data.frame(S=rep(S,length(tau)),Tau=rep(tau,each=length(S)))
Grafica[,"Delta"] <- mapply(Delta,Grafica$S,K,Grafica$Tau,r,q,sigma,tipo)
Grafica <- left_join(Grafica,tau_aux,by = "Tau")
Grafica$Tau <- NULL
ggplot(Grafica,aes(x=S,y=Delta,color=Vencimiento)) +
  geom_line() +
  labs(title="Delta Put",subtitle = "Largo",x="Subyacente")

```

## Gamma

La gamma corresponde a la sensibilidad de la delta del derivado con respecto al precio del subyacente.
\begin{equation}
\Gamma = \frac{\partial^2 BS}{\partial S^2} = \frac{e^{-q\tau}N'(d_1)}{S\sigma\sqrt{\tau}}.
\end{equation}
Este valor representa que tanto se debe de reajustar la delta para hacer el delta-hedge.

```{r,echo=TRUE,fig.height=3}
# Gamma
Gamma <- function(S,K,tau,r,q,sigma){
  d1 <- (log(S/K)+(r-q-.5*sigma^2)*tau)/(sigma*sqrt(tau))
  griega <- exp(-q*tau)*dnorm(d1)/(S*sigma*sqrt(tau))
  return(griega)
}

tipo <- 1
Grafica <- data.frame(S=rep(S,length(tau)),Tau=rep(tau,each=length(S)))
Grafica[,"Gamma"] <- mapply(Gamma,Grafica$S,K,Grafica$Tau,r,q,sigma)
Grafica <- left_join(Grafica,tau_aux,by = "Tau")
Grafica$Tau <- NULL
ggplot(Grafica,aes(x=S,y=Gamma,color=Vencimiento)) +
  geom_line() +
  labs(title="Gamma",subtitle = "Largo",x="Subyacente")

```

## Vega

La vega corresponde a la sensibilidad del derivado con respecto al parámetro de la volatilidad.
\begin{equation}
\nu = \frac{\partial BS}{\partial \sigma} = Se^{-q\tau}N'(d_1)\sqrt{\tau}.
\end{equation}
Este valor representa los cambios en el precio debido a cambios en la volatilidad.

```{r,echo=TRUE,fig.height=3}
# Vega
Vega <- function(S,K,tau,r,q,sigma){
  d1 <- (log(S/K)+(r-q-.5*sigma^2)*tau)/(sigma*sqrt(tau))
  griega <- S*exp(-q*tau)*dnorm(d1)*sqrt(tau)
  return(griega)
}

tipo <- 1
Grafica <- data.frame(S=rep(S,length(tau)),Tau=rep(tau,each=length(S)))
Grafica[,"Vega"] <- mapply(Vega,Grafica$S,K,Grafica$Tau,r,q,sigma)
Grafica <- left_join(Grafica,tau_aux,by = "Tau")
Grafica$Tau <- NULL
ggplot(Grafica,aes(x=S,y=Vega,color=Vencimiento)) +
  geom_line() +
  labs(title="Vega",subtitle = "Largo",x="Subyacente")

```

## Theta

La theta corresponde a la sensibilidad del derivado con respecto al vencimiento.
\begin{equation}
\Theta = \frac{\partial BS}{\partial \tau} = -\frac{e^{-q\tau}SN'(d_1)\sigma}{2\sqrt{\tau}}-\phi rKe^{-r\tau}N(\phi d_2)+\phi qSe^{-q\tau}N(\phi d_1).
\end{equation}
Este valor representa los cambios en el precio a medida que la opción se acerca a vencimiento.

```{r,echo=TRUE,fig.height=3}
# Theta
Theta <- function(S,K,tau,r,q,sigma,tipo){
  d1 <- (log(S/K)+(r-q-.5*sigma^2)*tau)/(sigma*sqrt(tau))
  d2 <- d1-sigma*sqrt(tau)
  griega <- -.5*exp(-q*tau)*S*dnorm(d1)*sigma/sqrt(tau)
            -tipo*r*K*exp(-r*tau)*pnorm(tipo*d2)
            +tipo*q*S*exp(-q*tau)*pnorm(tipo*d1)
  return(griega)
}

S <- c(17,19,21,23)
tau <- seq(7,360)/360

tipo <- 1
Grafica <- data.frame(S=rep(S,length(tau)),Tau=rep(tau,each=length(S)))
Grafica[,"Theta"] <- mapply(Theta,Grafica$S,K,Grafica$Tau,r,q,sigma,tipo)
Grafica$S <- factor(Grafica$S)
ggplot(Grafica,aes(x=Tau,y=Theta,color=S)) +
  geom_line() +
  labs(title="Theta Call",subtitle = "Largo",color="Subyacente",x="Vencimiento")

tipo <- -1
Grafica <- data.frame(S=rep(S,length(tau)),Tau=rep(tau,each=length(S)))
Grafica[,"Theta"] <- mapply(Theta,Grafica$S,K,Grafica$Tau,r,q,sigma,tipo)
Grafica$S <- factor(Grafica$S)
ggplot(Grafica,aes(x=Tau,y=Theta,color=S)) +
  geom_line() +
  labs(title="Theta Put",subtitle = "Largo",color="Subyacente",x="Vencimiento")

```


## Aproximaciones con Griegas

Otro uso de las griegas es realizar aproximaciones del precio o del PnL (Profit & Loss).

Aplicando series de Taylor al precio de una opción $V(t)$ obtenemos
\begin{equation}
V(S+\delta S,t+ \delta t) = V(S,t)+\Delta\delta S+\frac{1}{2}\Gamma\delta S^2+\Theta\delta t+o(\delta S,\delta t)
\end{equation}

Ahora tomemos un portafolio el cual consta del derivado $V(t)$ y $M$ unidades del subyacente $S$, i.e.
\begin{equation}
P(S,t) = V(S,t) + M\cdot S,
\end{equation}
de modo que
\begin{equation}
P(S+\delta S,t+ \delta t) = P(S,t)+(M+\Delta)\delta S+\frac{1}{2}\Gamma\delta S^2+\Theta\delta t+o(\delta S,\delta t).
\end{equation}

El PnL a tiempo $t+\delta t$ puede ser calculado como
\begin{equation}
PnL_{t+\delta t}=P(S+\delta S,t+ \delta t)-P(S,t) = (M+\Delta)\delta S+\frac{1}{2}\Gamma\delta S^2+\Theta\delta t+o(\delta S,\delta t).
\end{equation}
En el caso de un portafolio delta hedged se tendría $M=-\Delta$, con lo cual se tendría
\begin{equation}
PnL_{t+\delta t}=\frac{1}{2}\Gamma\delta S^2+\Theta\delta t+o(\delta S,\delta t).
\end{equation}

El razonamiento anterior se puede extender para incluir más griegas y hacer *vega-hedge*.

## Ejercicios

**Ejercicio** Exprese la $\Delta_{\text{Call}}$ en términos de $\Delta_{\text{Put}}$.

**Ejercicio** Demuestre que la $\Gamma_{\text{Call}}=\Gamma_{\text{Put}}$ y que $\nu_{\text{Call}}=\nu_{\text{Put}}$.

**Ejercicio (Forward Delta)** Demuestre que el número de forwards largos para cubrir una opción corta es $\phi N(\phi d_1)$.

**Ejercicio (Simetría Put-Call)** Definimos el precio forward $F(\tau)$ como el strike $K$ tal que el precio del forward es igual a cero.
Demuestre que $BS(S,K,\tau,r,q,\sigma,1)=\frac{K}{F(\tau)}BS\left(S,\frac{F^2(\tau)}{K},\tau,r,q,\sigma,-1\right)$.

**Ejercicio (Delta ATM)** Encuentre el strike $K$ tal que $\Delta_{\text{Call}}+\Delta_{\text{Put}}=0$

**Ejercicio (Strike en términos de Delta)** Exprese el strike $K$ en términos de delta $\Delta=\phi N(\phi d_1)$

**Ejercicio** Grafique la delta, gamma y vega con respecto al tiempo y la theta con respecto al subyacente e interprete las gráficas.

## Bibliografía

* Hull, J. (2018) *Options, Futures and other Derivative Securities*, 10th edition, Pearson, New York.
* Shreve, S. (2004) *Stochastic Calculus for Finance II: Continuous-Time Models*, Springer-Verlag, New York.
* Wystup, U. (2017) *FX Options and Structure Products*, Wiley, United Kingdom.
